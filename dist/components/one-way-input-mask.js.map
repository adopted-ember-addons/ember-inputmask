{"version":3,"file":"one-way-input-mask.js","sources":["../../src/components/one-way-input-mask.gts"],"sourcesContent":["import Component from '@glimmer/component';\nimport { schedule } from '@ember/runloop';\nimport { on } from '@ember/modifier';\nimport { modifier } from 'ember-modifier';\nimport Inputmask from 'inputmask';\nimport { areDifferent } from '../utils/compare-objects.ts';\n\nconst DEFAULT_OPTIONS = {\n  rightAlign: false,\n};\n\n// Export for backwards compatibility with classic child components\nexport const DEFAULT_NON_BOUND_PROPS = [\n  'keyEvents',\n  'update',\n  'mask',\n  'alias',\n  'options',\n];\n\nexport interface OneWayInputMaskSignature {\n  Element: HTMLInputElement;\n  Args: {\n    alias?: Inputmask.Options['alias'];\n    mask?: Inputmask.Options['mask'];\n    options?: Inputmask.Options;\n    value?: string | number;\n    update?: (unmaskedValue: string, maskedValue: string) => void;\n    onenter?: (value: string) => void;\n    onescape?: (value: string) => void;\n    type?: string;\n  };\n}\n\n/**\n * Displays an input with the specified mask applied to it\n * using Inputmask library. Follows Data-down actions up pattern\n */\nexport default class OneWayInputMask extends Component<OneWayInputMaskSignature> {\n  private _oldMask: Inputmask.Options['mask'] = '';\n  private _oldAlias: Inputmask.Options['alias'] = undefined;\n  private _oldOptions: Inputmask.Options | null = null;\n  private _didInsertElement = false;\n\n  private inputElement?: HTMLInputElement;\n\n  private keyEvents = {\n    13: 'onenter',\n    27: 'onescape',\n  };\n\n  setupInputModifier = modifier((element: HTMLInputElement) => {\n    this.inputElement = element;\n    this._setupMask();\n    this._didInsertElement = true;\n\n    return () => {\n      this._destroyMask();\n    };\n  });\n\n  updateMaskModifier = modifier(() => {\n    this.updateMask();\n  });\n\n  get _options(): Inputmask.Options {\n    const options = Object.assign({}, DEFAULT_OPTIONS, this.args.options);\n    if (this.args.alias) {\n      options.alias = this.args.alias;\n    } else {\n      options.mask = this.args.mask;\n    }\n    return options;\n  }\n\n  private get _value(): string | number {\n    return this.args.value ?? '';\n  }\n\n  private updateMask = (): void => {\n    const mask = this.args.mask ?? '';\n    const alias = this.args.alias;\n    const oldMask = this._oldMask;\n    const oldAlias = this._oldAlias;\n    const didMaskChange = mask !== oldMask;\n    const didAliasChange = alias !== oldAlias;\n    const options = this.args.options ?? {};\n    const oldOptions = this._oldOptions ?? {};\n    const didOptionsChange = areDifferent(options, oldOptions);\n\n    // We want to reapply the mask if it has changed\n    if (didMaskChange || didAliasChange || didOptionsChange) {\n      this._oldMask = mask;\n      this._oldAlias = alias;\n      this._oldOptions = this.args.options ?? null;\n      this._changeMask();\n    }\n  };\n\n  handleKeyUp = (event: KeyboardEvent): void => {\n    const method = this.keyEvents[event.keyCode as 13 | 27];\n    if (method && this.args[method as 'onenter' | 'onescape']) {\n      this.args[method as 'onenter' | 'onescape']?.(\n        (event.target as HTMLInputElement).value,\n      );\n    }\n  };\n\n  handleInput = (event: Event): void => {\n    this._processNewValue((event.target as HTMLInputElement).value);\n  };\n\n  /**\n   * Send the update action with the values. Components that inherit from this may\n   * need to override this if they want to pass additional data on the update\n   */\n  protected sendUpdate(unmaskedValue: string, value: string): void {\n    this.args.update?.(unmaskedValue, value);\n  }\n\n  /**\n   * If this component's consumer modifies the passed in `value` inside their `update`\n   * method we want to make sure that value is reflected in the input's display.\n   */\n  private _syncValue(): void {\n    if (!this.inputElement) return;\n\n    const actualValue = this._value;\n    const renderedValue = this.inputElement.value;\n\n    if (actualValue !== renderedValue) {\n      this.inputElement.inputmask?.setValue(String(actualValue));\n    }\n  }\n\n  /**\n   * Handle when a new value changes\n   */\n  private _processNewValue(value: string): void {\n    if (!this.inputElement) return;\n\n    const cursorStart = this.inputElement.selectionStart ?? 0;\n    const cursorEnd = this.inputElement.selectionEnd ?? 0;\n    const unmaskedValue = this._getUnmaskedValue();\n    const oldUnmaskedValue = this._value;\n    const options = this._options;\n\n    // We only want to make changes if something is different so we don't cause infinite loops or\n    // double renders.\n    // We want to make sure that that values we compare are going to come out the same through\n    // the masking algorithm, to ensure that we only call `update` if the values are actually different\n    // (e.g. '1234.' will be masked as '1234' and so when `update` is called and passed back\n    // into the component the decimal will be removed, we don't want this)\n    if (\n      Inputmask.format(String(oldUnmaskedValue), options) !==\n      Inputmask.format(unmaskedValue, options)\n    ) {\n      this.sendUpdate(unmaskedValue, value);\n\n      // When the value is updated, and then sent back down the cursor moves to the end of the field.\n      // We therefore need to put it back to where the user was typing so they don't get janked around\n      // eslint-disable-next-line ember/no-runloop -- Required for Ember 5.8/5.12 compatibility\n      schedule('afterRender', () => {\n        this._syncValue();\n        this.inputElement?.setSelectionRange(cursorStart, cursorEnd);\n      });\n    }\n  }\n\n  /**\n   * Connect the 3rd party input masking library to the element\n   */\n  private _setupMask(): void {\n    if (!this.inputElement) return;\n\n    const inputmask = new Inputmask(this._options);\n    inputmask.mask(this.inputElement);\n  }\n\n  /**\n   * Get the value of the element without the mask\n   */\n  private _getUnmaskedValue(): string {\n    if (!this.inputElement) return '';\n    return this.inputElement.inputmask?.unmaskedvalue() ?? '';\n  }\n\n  /**\n   * Destroy and reapply the mask when the mask or options change so the mask and\n   * options can be dynamic\n   */\n  private _changeMask(): void {\n    if (\n      this._didInsertElement &&\n      this.inputElement &&\n      this.inputElement.inputmask\n    ) {\n      this._destroyMask();\n      this._setupMask();\n    }\n  }\n\n  private _destroyMask(): void {\n    this.inputElement?.inputmask?.remove();\n  }\n\n  <template>\n    <input\n      type={{@type}}\n      value={{this._value}}\n      {{this.setupInputModifier}}\n      {{this.updateMaskModifier @mask @options}}\n      {{on \"input\" this.handleInput}}\n      {{on \"keyup\" this.handleKeyUp}}\n      ...attributes\n    />\n  </template>\n}\n"],"names":["DEFAULT_OPTIONS","rightAlign","DEFAULT_NON_BOUND_PROPS","OneWayInputMask","Component","_oldMask","_oldAlias","undefined","_oldOptions","_didInsertElement","inputElement","keyEvents","setupInputModifier","modifier","element","_setupMask","_destroyMask","updateMaskModifier","updateMask","_options","options","Object","assign","args","alias","mask","_value","value","oldMask","oldAlias","didMaskChange","didAliasChange","oldOptions","didOptionsChange","areDifferent","_changeMask","handleKeyUp","event","method","keyCode","target","handleInput","_processNewValue","sendUpdate","unmaskedValue","update","_syncValue","actualValue","renderedValue","inputmask","setValue","String","cursorStart","selectionStart","cursorEnd","selectionEnd","_getUnmaskedValue","oldUnmaskedValue","Inputmask","format","schedule","setSelectionRange","unmaskedvalue","remove","setComponentTemplate","precompileTemplate","strictMode","scope","on"],"mappings":"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"}